#!/usr/bin/env python

import os

import bs4
import pathlib
import requests

# Set your Pocket API credentials.
consumer_key = os.getenv('POCKET_CONSUMER_KEY')
access_token = os.getenv('POCKET_ACCESS_TOKEN')

url = 'https://getpocket.com/v3/get'
unique_urls = set()
headers = {'X-Accept': 'application/json'}

print('Retrieving the list of archived and unread articles from Pocket...')
data = {
    'consumer_key': consumer_key,
    'access_token': access_token,
    'sort': 'newest',  # Sort articles by newest first
    'detailType': 'complete'  # Retrieve complete article details
}

response = requests.post(url, data=data, headers=headers)
articles = response.json()['list']

for article_id, article_data in articles.items():
    full_article_url = article_data['given_url']
    # Remove extra crap from URLS (DANGEROUS - don't remove too much!)
    article_url = filterurl(full_article_url, '?utm')
    unique_urls.add(article_url)

print('Loading articles from medium reading list data dump...')

file_content = pathlib.Path('reading-list.html').read_text()
soup = bs4.BeautifulSoup(file_content, 'html.parser')

data = {
    "consumer_key": consumer_key,
    "access_token": access_token,
    "actions": []
}

# Find all anchor tags with 'a' within the reading list.
for anchor_tag in soup.find_all('a'):
    url = anchor_tag.get('href')
    if url not in unique_urls:
        unique_urls.add(url)
        action = {
            "action": "add",
            "url": url
        }
        data["actions"].append(action)

# FIXME: I need to figure out how to get the link the medium shorted url points to. do i need to filter it? 

# Batch add articles to Pocket. 
url = "https://getpocket.com/v3/add"

headers = {
    "Content-Type": "application/json; charset=UTF-8",
    "X-Accept": "application/json"
}

response = requests.post(url, headers=headers, json=data)

if response.status_code == 200:
    print("Articles successfully added to Pocket!")
else:
    print("Failed to add articles to Pocket.")

# If necessary, I can update this to get the access token via script as follows:
# https://gist.github.com/Mierdin/0996952ba02d87175f3b
# https://gist.github.com/alexpyoung/7e241a8f3f805630f0f66a1cf0763675#file-pocket_import-L71

# Otherwise use this service: http://reader.fxneumann.de/plugins/oneclickpocket/auth.php
