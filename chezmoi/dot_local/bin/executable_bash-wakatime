#!/usr/bin/env bash

# wakatime for bash
#
# include this file in your "~/.bashrc" file with this command:
#   . path/to/bash-wakatime.sh
#
# or this command:
#   source path/to/bash-wakatime.sh
#
# But if you already have a PROMPT_COMMAND variable set,
# just merge yout own pre_prompt_command with the following one.
# And don't forget to create and configure your "~/.wakatime.cfg" file.
#

set -o errexit                # Exit on error. Append || true if you expect an error.
set -o errtrace               # Exit on error inside any functions or subshells.
set -o noclobber              # Don't allow overwriting files.
set -o nounset                # Don't allow use of undefined vars. Use ${VAR:-} to use an undefined VAR.
set -o pipefail               # Produce a failure return code if any pipeline command errors.
shopt -s failglob             # Cause globs that don't get expanded to cause errors.
shopt -s globstar 2>/dev/null # Match all files and zero or more sub-directories.

# hook function to send wakatime a tick
pre_prompt_command() {
    # shellcheck disable=SC2046,SC2312
    wakatime --write --plugin "bash-wakatime/0.0.1" \
        --entitytype app --project Terminal \
        --entity "$(fc -ln -0 | cut -d ' ' -f1)" \
        >/dev/null 2>&1 &
}

PROMPT_COMMAND=pre_prompt_command
