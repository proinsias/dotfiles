#!/usr/bin/env bash

set -o errexit                # Exit on error. Append || true if you expect an error.
set -o errtrace               # Exit on error inside any functions or subshells.
set -o noclobber              # Don't allow overwriting files.
set -o nounset                # Don't allow use of undefined vars. Use ${VAR:-} to use an undefined VAR.
set -o pipefail               # Produce a failure return code if any pipeline command errors.
shopt -s failglob             # Cause globs that don't get expanded to cause errors.
shopt -s globstar 2>/dev/null # Match all files and zero or more sub-directories.

# Get age key from 1password and save it to disk.
# Requires 1password CLI to be installed and signed in.
getagekey() {
    OUTPUT="$(op read "op://Parents/chezmoi/public-key")"
    echo "# public key: ${OUTPUT}"
    op read "op://Parents/chezmoi/key.txt"
}

mkdir -p ~/.config/chezmoi ~/.config/mise

getagekey >|~/.config/chezmoi/key.txt

cp -f -l ~/.config/chezmoi/key.txt ~/.config/mise/age.txt
