#!/usr/bin/env bash
#
# ==============================================================================
#
#                            iCloud Photos Backup Script
#
# ==============================================================================
#
# Purpose:
#   This script automates the process of backing up iCloud Photos for multiple
#   users to a designated external hard drive. It uses 'icloudpd' to download
#   photos and videos from specified iCloud accounts and libraries.
#
# Dependencies:
#   - icloudpd: A command-line tool to download iCloud photos.
#     (https://github.com/icloud-photos-downloader/icloud_photos_downloader)
#   - runitor: A command runner with healthchecks.io integration.
#     (https://github.com/bdd/runitor)
#   - bash: The script is written for the bash shell.
#   - macOS Keychain: The script is configured to use 'keyring' to securely
#     fetch iCloud passwords, which typically integrates with the macOS Keychain.
#
# Pre-run Configuration:
#   1. Ensure 'icloudpd' is installed and accessible in your system's PATH.
#   2. The target backup volume, "/Volumes/My Passport/", must be mounted and
#      writable.
#   3. For non-interactive execution, ensure the iCloud account passwords are
#      stored in your system's keychain so 'icloudpd' can retrieve them via
#      the 'keyring' password provider. If not found, 'icloudpd' will fall
#      back to prompting for the password on the console.
#   4. Set the CHECK_UUID environment variable for runitor.
#
# Usage:
#   Execute the script from your terminal:
#   backup_photos
#
# Script Breakdown:
#   The script executes a series of 'icloudpd' commands, one for each user
#   or library to be backed up.
#
#   - For 'francis.odonovan+apple@gmail.com', it backs up both the personal
#     "PrimarySync" library and a specific "SharedSync" library.
#   - For other users ('clslesnick@gmail.com', 'bea.odonovan@icloud.com',
#     'arthur.odonovan@icloud.com'), it backs up their primary photo libraries.
#
# Email Notifications (for 2FA Expiration):
#   The script is configured to send email notifications if an account's
#   two-factor authentication session expires.
#
# Scheduling with launchd and Lingon X:
#   'Lingon X' is a powerful graphical application that makes it easy to create
#   and manage launchd jobs without manually writing XML .plist files.
#
#   1.  **Create a New Job:**
#       - Open Lingon X and click the '+' button to create a new job.
#       - Choose to create a "User Agent". This ensures the job runs when you are
#         logged in and has access to your user keychain.
#
#   2.  **Name the Job:**
#       - Use a descriptive, reverse-domain name, e.g., `com.yourname.backup-icloud-photos`.
#
#   3.  **Define the Command:**
#       - In the "What" section, enter the absolute path to this script.
#         After being applied by chezmoi, this is likely in `~/.local/bin/`.
#         Example: `/Users/your-username/.local/bin/backup_photos`
#       - **Important:** `launchd` requires absolute paths.
#
#   4.  **Set the Schedule:**
#       - In the "When" section, check "Run on a schedule".
#       - Set a calendar interval. For example, to run every day at 2:00 AM, you
#         would set the interval for every 1 day, at Hour 2, Minute 0.
#
#   5.  **Log Script Output (Recommended):**
#       - It's crucial to log the script's output to debug any issues.
#       - In the "Advanced" section of Lingon X, you can set paths for
#         "Standard Out Log" and "Standard Error Log".
#       - Example: `~/Library/Logs/icloud_backup.log` for both.
#
#   6.  **Save and Enable:**
#       - Click "Save" in Lingon X. The job will be enabled and will run on the
#         schedule you defined.
#
# TODO:
#   - Set up this script to run automatically on a schedule using a cron job with pushover.net notifications.

set -o errexit                # Exit on error. Append || true if you expect an error.
set -o errtrace               # Exit on error inside any functions or subshells.
set -o noclobber              # Don't allow overwriting files.
set -o nounset                # Don't allow use of undefined vars. Use ${VAR:-} to use an undefined VAR.
set -o pipefail               # Produce a failure return code if any pipeline command errors.
shopt -s failglob             # Cause globs that don't get expanded to cause errors.
shopt -s globstar 2>/dev/null # Match all files and zero or more sub-directories.

run_icloudpd() {
    icloudpd \
        --notification-email "${SMTP_USERNAME}" \
        --password-provider keyring \
        --password-provider console \
        --smtp-host "smtp.gmail.com" \
        --smtp-port 587 \
        --smtp-username "${SMTP_USERNAME}" \
        --smtp-password "${SMTP_PASSWORD}" \
        --username "${APPLE_USERNAME_1}" \
        --directory "/Volumes/My Passport/Backups/Photos/Francis" \
        --library "PrimarySync" \
        --username "${APPLE_USERNAME_1}" \
        --directory "/Volumes/My Passport/Backups/Photos/Francis" \
        --library "${APPLE_LIBRARY}" \
        --username "${APPLE_USERNAME_2}"\
        --directory "/Volumes/My Passport/Backups/Photos/Cathy" \
        --username "${APPLE_USERNAME_3}" \
        --directory "/Volumes/My Passport/Backups/Photos/Bea" \
        --username "${APPLE_USERNAME_4}" \
        --directory "/Volumes/My Passport/Backups/Photos/Arthur"
}

run_icloudpd_version() {
    icloudpd --version
}

export PATH="/usr/local/bin:/opt/homebrew/bin:${PATH}"
export -f run_icloudpd
export -f run_icloudpd_version

runitor -- bash -c 'run_icloudpd | tail --bytes=100000'
