#!/usr/bin/env bash
# shellcheck disable=SC2312

# FIXME: https://nix.dev/tutorials/first-steps/reproducible-scripts.html

# shellcheck source=/Users/ftod/.env
source ~/.env

# Intel homebrew
test -f /usr/local/bin/brew && SHELLENV="$(/usr/local/bin/brew shellenv)" && eval "${SHELLENV}"
# M1 home-brew. Do second in case we are also using Intel via Rosetta.
test -f /opt/homebrew/bin/brew && SHELLENV="$(/opt/homebrew/bin/brew shellenv)" && eval "${SHELLENV}"

host="$(hostname -s)"
export host
dt="$(gdate --iso-8601)"
export dt
HOMEBREW_PREFIX="$(brew --prefix)"
export HOMEBREW_PREFIX
RUBY_HOME="${HOMEBREW_PREFIX}/opt/ruby"
export RUBY_HOME
RUBY_VERSION="3.1.0"
export RUBY_VERSION
GEM_HOME="${RUBY_HOME}/lib/ruby/gems/${RUBY_VERSION}"
export GEM_HOME
GEM_PATH="${RUBY_HOME}/lib/ruby/gems/${RUBY_VERSION}"
export GEM_PATH
PATH="${HOME}/bin:${HOME}/.local/bin:/usr/local/google-cloud-sdk/bin:${RUBY_HOME}/bin${PATH:+:${PATH}}"
export PATH
DEBIAN_FRONTEND="noninteractive"
export DEBIAN_FRONTEND

update_all() {
    if type apt-get >/dev/null 2>&1; then
        echo -e "\apt-get update:"
        apt-get update --yes
        echo -e "\apt-get upgrade:"
        apt-get upgrade --yes
    fi

    if type pre-commit-autoupdate >/dev/null 2>&1; then
        echo -e "\npre-commit-autoupdate:"
        pre-commit-autoupdate
    else
        echo -e "\npre-commit-autoupdate not found!"
    fi

    if type topgrade >/dev/null 2>&1; then
        echo -e "\topgrade:"

        topgrade --cleanup --no-retry --yes --disable certbot gcloud gitrepos mas nix system tlmgr uv
    else
        echo -e "\topgrade not found!"
    fi

    if type ~/GitHub/dotfiles/install.sh >/dev/null 2>&1; then
        (
            echo -e "\ndotfiles/install.sh:"
            ~/GitHub/dotfiles/install.sh
        )
    fi

    if type uncommitted-francis >/dev/null 2>&1; then
        echo -e "\nuncommitted-francis:"
        uncommitted-francis "${HOME}"
    else
        echo -e "\nuncommitted-francis not found!"
    fi

    if type docker-cleanup >/dev/null 2>&1; then
        docker-cleanup
    fi

    if type apt-get >/dev/null 2>&1; then
        apt list --upgradeable
    fi

    if type brew >/dev/null 2>&1; then
        brew outdated
    else
        echo -e "\nbrew not found!"
    fi

    if type gcloud >/dev/null 2>&1; then
        echo -e "\ngcloud components list 2>&1 | grep \"Update Available\":"
        # shellcheck disable=SC2312
        gcloud components list 2>&1 | grep "Update Available"
        # To upgrade, run: `sudo gcloud components update --quiet`.
    fi

    if [ "${-#*i}" == "$-" ]; then
        if type topgrade >/dev/null 2>&1; then
            echo -e "\topgrade interactive:"
            topgrade --cleanup --only certbot gcloud nix system tlmgr --no-retry --yes
        fi

        # shellcheck disable=SC2065
        if test -d ~/favs/gh/mac-playbook >/dev/null 2>&1; then
            echo -e "\n~/favs/gh/mac-playbook:"
            cd ~/favs/gh/mac-playbook || exit

            ansible-playbook main.yml --inventory inventory --tags "personal"

            cd - || exit
        fi

    fi

}

pop <<<"$(update_all)" \
    --to "${POP_TO}" \
    --subject "update_all_${host}_${dt}.txt"
