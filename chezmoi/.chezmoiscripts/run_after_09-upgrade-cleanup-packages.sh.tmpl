#!/usr/bin/env bash

set -o errexit    # Exit on error. Append || true if you expect an error.
set -o errtrace   # Exit on error inside any functions or subshells.
set -o noclobber  # don't allow overwriting files
set -o nounset    # Don't allow use of undefined vars. Use ${VAR:-} to use an undefined VAR.
set -o pipefail   # Produce a failure return code if any pipeline command errors
shopt -s failglob # Cause globs that don't get expanded to cause errors

echo -e "\n\nUpgrade packages."

{{ if and (eq .chezmoi.os "linux") (or (eq .chezmoi.osRelease.id "debian") (eq .chezmoi.osRelease.id "ubuntu")) }}
# Only run if it is an interactive shell
if [[ -t 0 ]] && [[ -n "${PS1:-}" ]] && [[ "$-" == *i* ]]; then
    echo -e "\napt-get update:"
    sudo apt-get update --yes
    echo -e "\napt-get upgrade:"
    sudo apt-get upgrade --yes
    apt list --upgradeable
fi
{{ end }}

echo -e "\nbrew upgrade:"
if [[ -t 0 ]] && [[ -n "${PS1:-}" ]] && [[ "$-" == *i* ]]; then
    brew upgrade --greedy
else
    brew upgrade --formulae
fi

echo -e "\nbrew cleanup:"
brew cleanup

echo -e "\nbrew link:"
brew link docker handbrake httpie ollama || true

echo -e "\nbrew doctor:"
brew doctor || true

echo -e "\nbrew outdated:"
brew outdated

# echo -e "\ndocker-cleanup:"
# docker-cleanup

if type gcloud >/dev/null 2>&1; then
    if [[ -t 0 ]] && [[ -n "${PS1:-}" ]] && [[ "$-" == *i* ]]; then
        echo -e "\ngcloud components update:"
        sudo gcloud components update --quiet
    fi
fi

echo -e "\nmise upgrade:"
mise upgrade --bump

echo -e "\nmise doctor:"
mise doctor

{{ if and (eq .chezmoi.os "darwin") (not .work)}}
echo -e "\nmas upgrade:"
mas upgrade
{{ end }}

# echo -e "\npre-commit-autoupdate:"
# pre-commit-autoupdate | grep -v "already up to date"

if [[ -t 0 ]] && [[ -n "${PS1:-}" ]] && [[ "$-" == *i* ]]; then
    echo -e "\ntopgrade:"
    # FIXME: Setup git_repos? uv? myrepos?
    sudo --validate
    topgrade --cleanup --no-retry --skip-notify --yes --disable \
        brew_cask \
        brew_formula \
        bun_packages \
        chezmoi \
        containers \
        git_repos \
        mas \
        mise \
        nix \
        pip3 \
        poetry \
        rustup \
        uv
fi

echo -e "\nuncommitted-francis:"
uncommitted-francis "${HOME}"/git

echo -e "\nuv cache prune:"
uv cache prune
